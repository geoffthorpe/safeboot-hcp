HCP_GUIRDESKTOPWEB_SRC := $(HCP_GUI_SRC)/rdesktop-web
HCP_GUIRDESKTOPWEB_OUT := $(HCP_GUI_OUT)/rdesktop-web
HCP_GUIRDESKTOPWEBBUILD_DNAME := $(call HCP_IMAGE,guirdesktopweb-build)
HCP_GUIRDESKTOPWEBBUILD_DFILE := $(HCP_GUIRDESKTOPWEB_OUT)/Dockerfile.build
HCP_GUIRDESKTOPWEBBUILD_TFILE := $(HCP_GUIRDESKTOPWEB_OUT)/built.build
HCP_GUIRDESKTOPWEB_DNAME := $(call HCP_IMAGE,guirdesktopweb)
HCP_GUIRDESKTOPWEB_DFILE := $(HCP_GUIRDESKTOPWEB_OUT)/Dockerfile
HCP_GUIRDESKTOPWEB_TFILE := $(HCP_GUIRDESKTOPWEB_OUT)/built

$(HCP_GUIRDESKTOPWEB_OUT): | $(HCP_GUI_OUT)
MDIRS += $(HCP_GUIRDESKTOPWEB_OUT)

# "guirdesktopweb" is the intended result. "guirdesktopweb-build" is the
# guirdesktopweb-specific derivation of "guibuilder", which builds the stuff that
# guirdesktopweb depends on.
guirdesktopweb-build: $(HCP_GUIRDESKTOPWEBBUILD_TFILE)
guirdesktopweb: $(HCP_GUIRDESKTOPWEB_TFILE)
ALL += $(HCP_GUIRDESKTOPWEBBUILD_TFILE) $(HCP_GUIRDESKTOPWEB_TFILE)

$(HCP_GUIRDESKTOPWEBBUILD_DFILE): | $(HCP_GUIRDESKTOPWEB_OUT)
$(HCP_GUIRDESKTOPWEBBUILD_DFILE): $(HCP_GUIRDESKTOPWEB_SRC)/Makefile
$(HCP_GUIRDESKTOPWEBBUILD_DFILE): $(HCP_GUIRDESKTOPWEB_SRC)/Dockerfile.build
$(HCP_GUIRDESKTOPWEBBUILD_DFILE):
	$Qecho "FROM $(HCP_GUIBUILDER_DNAME)" > $@
	$Qcat $(HCP_GUIRDESKTOPWEB_SRC)/Dockerfile.build >> $@

$(HCP_GUIRDESKTOPWEB_DFILE): | $(HCP_GUIRDESKTOPWEB_OUT)
$(HCP_GUIRDESKTOPWEB_DFILE): $(HCP_GUIRDESKTOPWEB_SRC)/Makefile
$(HCP_GUIRDESKTOPWEB_DFILE): $(HCP_GUIRDESKTOPWEB_SRC)/Dockerfile
$(HCP_GUIRDESKTOPWEB_DFILE):
	$Qecho "FROM $(HCP_GUIRDESKTOP_DNAME)" > $@
	$Qcat $(HCP_GUIRDESKTOPWEB_SRC)/Dockerfile | \
		sed -e "s/%%BUILDER_DNAME%%/$(HCP_GUIRDESKTOPWEBBUILD_DNAME)/" >> $@

$(HCP_GUIRDESKTOPWEBBUILD_TFILE): $(HCP_GUIRDESKTOPWEBBUILD_DFILE)
$(HCP_GUIRDESKTOPWEBBUILD_TFILE): $(HCP_GUIBUILDER_TFILE)
$(HCP_GUIRDESKTOPWEBBUILD_TFILE): $(HCP_GUIRDESKTOPWEB_OUT)/files-extracted
$(HCP_GUIRDESKTOPWEBBUILD_TFILE):
	$Qecho "Building container image $(HCP_GUIRDESKTOPWEBBUILD_DNAME)"
	$Qdocker build -t $(HCP_GUIRDESKTOPWEBBUILD_DNAME) \
	               -f $(HCP_GUIRDESKTOPWEBBUILD_DFILE) \
	               $(HCP_GUIRDESKTOPWEB_OUT)
	$Qtouch $@
$(eval $(call pp_rule_docker_image_rm,\
	$(HCP_GUIRDESKTOPWEBBUILD_TFILE),\
	$(HCP_GUIRDESKTOPWEBBUILD_DNAME),\
	guirdesktopweb-build,\
	clean_guirdesktopweb))

$(HCP_GUIRDESKTOPWEB_OUT)/files-extracted: | $(HCP_GUIRDESKTOPWEB_OUT)
$(HCP_GUIRDESKTOPWEB_OUT)/files-extracted: $(HCP_GUIRDESKTOPWEB_SRC)/files.tar.gz
$(HCP_GUIRDESKTOPWEB_OUT)/files-extracted: 
	$Qcd $(HCP_GUIRDESKTOPWEB_OUT) && \
		rm -rf buildroot/ root/ && \
		tar zxf $(HCP_GUIRDESKTOPWEB_SRC)/files.tar.gz && \
		touch $@

$(HCP_GUIRDESKTOPWEB_TFILE): $(HCP_GUIRDESKTOPWEB_DFILE)
$(HCP_GUIRDESKTOPWEB_TFILE): $(HCP_GUIRDESKTOP_TFILE)
$(HCP_GUIRDESKTOPWEB_TFILE): $(HCP_GUIRDESKTOPWEBBUILD_TFILE)
$(HCP_GUIRDESKTOPWEB_TFILE): $(HCP_GUIRDESKTOPWEB_OUT)/files-extracted
$(HCP_GUIRDESKTOPWEB_TFILE):
	$Qecho "Building container image $(HCP_GUIRDESKTOPWEB_DNAME)"
	$Qdocker build -t $(HCP_GUIRDESKTOPWEB_DNAME) \
	               -f $(HCP_GUIRDESKTOPWEB_DFILE) \
	               $(HCP_GUIRDESKTOPWEB_OUT)
	$Qtouch $@
$(eval $(call pp_rule_docker_image_rm,\
	$(HCP_GUIRDESKTOPWEB_TFILE),\
	$(HCP_GUIRDESKTOPWEB_DNAME),\
	guirdesktopweb,\
	clean_guirdesktopweb))

# Cleanup (note, we allow 'rm -rf' rather than 'rm' here, because files.tar.gz
# is extracted)
ifneq (,$(wildcard $(HCP_GUIRDESKTOPWEB_OUT)))
clean_guirdesktopweb: | preclean
	$Qrm -f $(HCP_GUIRDESKTOPWEB_DFILE) $(HCP_GUIRDESKTOPWEB_TFILE)
	$Qrm -f $(HCP_GUIRDESKTOPWEBBUILD_DFILE) $(HCP_GUIRDESKTOPWEBBUILD_TFILE)
	$Qrm -rf $(HCP_GUIRDESKTOPWEB_OUT)
clean_guibuilder: clean_guirdesktopweb
endif
