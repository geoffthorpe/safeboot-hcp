HCP_WEBTOPRDESKTOP_SRC := $(HCP_WEBTOP_SRC)/rdesktop
HCP_WEBTOPRDESKTOP_OUT := $(HCP_WEBTOP_OUT)/rdesktop
HCP_WEBTOPRDESKTOPBUILD_DNAME := $(call HCP_IMAGE,webtoprdesktop-build)
HCP_WEBTOPRDESKTOPBUILD_DFILE := $(HCP_WEBTOPRDESKTOP_OUT)/Dockerfile.build
HCP_WEBTOPRDESKTOPBUILD_TFILE := $(HCP_WEBTOPRDESKTOP_OUT)/built.build
HCP_WEBTOPRDESKTOP_DNAME := $(call HCP_IMAGE,webtoprdesktop)
HCP_WEBTOPRDESKTOP_DFILE := $(HCP_WEBTOPRDESKTOP_OUT)/Dockerfile
HCP_WEBTOPRDESKTOP_TFILE := $(HCP_WEBTOPRDESKTOP_OUT)/built

$(HCP_WEBTOPRDESKTOP_OUT): | $(HCP_WEBTOP_OUT)
MDIRS += $(HCP_WEBTOPRDESKTOP_OUT)

# "webtoprdesktop" is the intended result. "webtoprdesktop-build" is the
# webtoprdesktop-specific derivation of "webtopbuilder", which builds the stuff that
# webtoprdesktop depends on.
webtoprdesktop-build: $(HCP_WEBTOPRDESKTOPBUILD_TFILE)
webtoprdesktop: $(HCP_WEBTOPRDESKTOP_TFILE)
ALL += $(HCP_WEBTOPRDESKTOPBUILD_TFILE) $(HCP_WEBTOPRDESKTOP_TFILE)

$(HCP_WEBTOPRDESKTOPBUILD_DFILE): | $(HCP_WEBTOPRDESKTOP_OUT)
$(HCP_WEBTOPRDESKTOPBUILD_DFILE): $(HCP_WEBTOPRDESKTOP_SRC)/Makefile
$(HCP_WEBTOPRDESKTOPBUILD_DFILE): $(HCP_WEBTOPRDESKTOP_SRC)/Dockerfile.build
$(HCP_WEBTOPRDESKTOPBUILD_DFILE):
	$Qecho "FROM $(HCP_WEBTOPBUILDER_DNAME)" > $@
	$Qcat $(HCP_WEBTOPRDESKTOP_SRC)/Dockerfile.build >> $@

$(HCP_WEBTOPRDESKTOP_DFILE): | $(HCP_WEBTOPRDESKTOP_OUT)
$(HCP_WEBTOPRDESKTOP_DFILE): $(HCP_WEBTOPRDESKTOP_SRC)/Makefile
$(HCP_WEBTOPRDESKTOP_DFILE): $(HCP_WEBTOPRDESKTOP_SRC)/Dockerfile
$(HCP_WEBTOPRDESKTOP_DFILE):
	$Qecho "FROM $(HCP_WEBTOPBASE_DNAME)" > $@
	$Qcat $(HCP_WEBTOPRDESKTOP_SRC)/Dockerfile | \
		sed -e "s/%%BUILDER_DNAME%%/$(HCP_WEBTOPRDESKTOPBUILD_DNAME)/" >> $@

$(HCP_WEBTOPRDESKTOPBUILD_TFILE): $(HCP_WEBTOPRDESKTOPBUILD_DFILE)
$(HCP_WEBTOPRDESKTOPBUILD_TFILE): $(HCP_WEBTOPBUILDER_TFILE)
$(HCP_WEBTOPRDESKTOPBUILD_TFILE):
	$Qecho "Building container image $(HCP_WEBTOPRDESKTOPBUILD_DNAME)"
	$Qdocker build -t $(HCP_WEBTOPRDESKTOPBUILD_DNAME) \
	               -f $(HCP_WEBTOPRDESKTOPBUILD_DFILE) \
	               $(HCP_WEBTOPRDESKTOP_OUT)
	$Qtouch $@
$(eval $(call pp_rule_docker_image_rm,\
	$(HCP_WEBTOPRDESKTOPBUILD_TFILE),\
	$(HCP_WEBTOPRDESKTOPBUILD_DNAME),\
	webtoprdesktop-build,\
	clean_webtoprdesktop))

$(HCP_WEBTOPRDESKTOP_OUT)/files.tar.gz: | $(HCP_WEBTOPRDESKTOP_OUT)
$(HCP_WEBTOPRDESKTOP_OUT)/files.tar.gz: $(HCP_WEBTOPRDESKTOP_SRC)/files.tar.gz
$(HCP_WEBTOPRDESKTOP_OUT)/files.tar.gz:
	$Qcp $< $@

$(HCP_WEBTOPRDESKTOP_TFILE): $(HCP_WEBTOPRDESKTOP_DFILE)
$(HCP_WEBTOPRDESKTOP_TFILE): $(HCP_WEBTOPBASE_TFILE)
$(HCP_WEBTOPRDESKTOP_TFILE): $(HCP_WEBTOPRDESKTOPBUILD_TFILE)
$(HCP_WEBTOPRDESKTOP_TFILE): $(HCP_WEBTOPRDESKTOP_OUT)/files.tar.gz
$(HCP_WEBTOPRDESKTOP_TFILE):
	$Qecho "Building container image $(HCP_WEBTOPRDESKTOP_DNAME)"
	$Qdocker build -t $(HCP_WEBTOPRDESKTOP_DNAME) \
	               -f $(HCP_WEBTOPRDESKTOP_DFILE) \
	               $(HCP_WEBTOPRDESKTOP_OUT)
	$Qtouch $@
$(eval $(call pp_rule_docker_image_rm,\
	$(HCP_WEBTOPRDESKTOP_TFILE),\
	$(HCP_WEBTOPRDESKTOP_DNAME),\
	webtoprdesktop,\
	clean_webtoprdesktop))

# Cleanup
ifneq (,$(wildcard $(HCP_WEBTOPRDESKTOP_OUT)))
clean_webtoprdesktop: | preclean
	$Qrm -f $(HCP_WEBTOPRDESKTOP_DFILE)
	$Qrm -f $(HCP_WEBTOPRDESKTOPBUILD_DFILE)
	$Qrm -rf $(HCP_WEBTOPRDESKTOP_OUT)
clean_webtopbuilder: clean_webtoprdesktop
endif
