HCP_WEBTOPRDESKTOPWEB_SRC := $(HCP_WEBTOP_SRC)/rdesktop-web
HCP_WEBTOPRDESKTOPWEB_OUT := $(HCP_WEBTOP_OUT)/rdesktop-web
HCP_WEBTOPRDESKTOPWEBBUILD_DNAME := $(call HCP_IMAGE,webtoprdesktopweb-build)
HCP_WEBTOPRDESKTOPWEBBUILD_DFILE := $(HCP_WEBTOPRDESKTOPWEB_OUT)/Dockerfile.build
HCP_WEBTOPRDESKTOPWEBBUILD_TFILE := $(HCP_WEBTOPRDESKTOPWEB_OUT)/built.build
HCP_WEBTOPRDESKTOPWEB_DNAME := $(call HCP_IMAGE,webtoprdesktopweb)
HCP_WEBTOPRDESKTOPWEB_DFILE := $(HCP_WEBTOPRDESKTOPWEB_OUT)/Dockerfile
HCP_WEBTOPRDESKTOPWEB_TFILE := $(HCP_WEBTOPRDESKTOPWEB_OUT)/built

$(HCP_WEBTOPRDESKTOPWEB_OUT): | $(HCP_WEBTOP_OUT)
MDIRS += $(HCP_WEBTOPRDESKTOPWEB_OUT)

# "webtoprdesktopweb" is the intended result. "webtoprdesktopweb-build" is the
# webtoprdesktopweb-specific derivation of "webtopbuilder", which builds the stuff that
# webtoprdesktopweb depends on.
webtoprdesktopweb-build: $(HCP_WEBTOPRDESKTOPWEBBUILD_TFILE)
webtoprdesktopweb: $(HCP_WEBTOPRDESKTOPWEB_TFILE)
ALL += $(HCP_WEBTOPRDESKTOPWEBBUILD_TFILE) $(HCP_WEBTOPRDESKTOPWEB_TFILE)

$(HCP_WEBTOPRDESKTOPWEBBUILD_DFILE): | $(HCP_WEBTOPRDESKTOPWEB_OUT)
$(HCP_WEBTOPRDESKTOPWEBBUILD_DFILE): $(HCP_WEBTOPRDESKTOPWEB_SRC)/Makefile
$(HCP_WEBTOPRDESKTOPWEBBUILD_DFILE): $(HCP_WEBTOPRDESKTOPWEB_SRC)/Dockerfile.build
$(HCP_WEBTOPRDESKTOPWEBBUILD_DFILE):
	$Qecho "FROM $(HCP_WEBTOPBUILDER_DNAME)" > $@
	$Qcat $(HCP_WEBTOPRDESKTOPWEB_SRC)/Dockerfile.build >> $@

$(HCP_WEBTOPRDESKTOPWEB_DFILE): | $(HCP_WEBTOPRDESKTOPWEB_OUT)
$(HCP_WEBTOPRDESKTOPWEB_DFILE): $(HCP_WEBTOPRDESKTOPWEB_SRC)/Makefile
$(HCP_WEBTOPRDESKTOPWEB_DFILE): $(HCP_WEBTOPRDESKTOPWEB_SRC)/Dockerfile
$(HCP_WEBTOPRDESKTOPWEB_DFILE):
	$Qecho "FROM $(HCP_WEBTOPRDESKTOP_DNAME)" > $@
	$Qcat $(HCP_WEBTOPRDESKTOPWEB_SRC)/Dockerfile | \
		sed -e "s/%%BUILDER_DNAME%%/$(HCP_WEBTOPRDESKTOPWEBBUILD_DNAME)/" >> $@

$(HCP_WEBTOPRDESKTOPWEB_OUT)/buildroot.tar.gz: | $(HCP_WEBTOPRDESKTOPWEB_OUT)
$(HCP_WEBTOPRDESKTOPWEB_OUT)/buildroot.tar.gz: $(HCP_WEBTOPRDESKTOPWEB_SRC)/buildroot.tar.gz
$(HCP_WEBTOPRDESKTOPWEB_OUT)/buildroot.tar.gz:
	$Qcp $< $@

$(HCP_WEBTOPRDESKTOPWEBBUILD_TFILE): $(HCP_WEBTOPRDESKTOPWEBBUILD_DFILE)
$(HCP_WEBTOPRDESKTOPWEBBUILD_TFILE): $(HCP_WEBTOPBUILDER_TFILE)
$(HCP_WEBTOPRDESKTOPWEBBUILD_TFILE): $(HCP_WEBTOPRDESKTOPWEB_OUT)/buildroot.tar.gz
$(HCP_WEBTOPRDESKTOPWEBBUILD_TFILE):
	$Qecho "Building container image $(HCP_WEBTOPRDESKTOPWEBBUILD_DNAME)"
	$Qdocker build -t $(HCP_WEBTOPRDESKTOPWEBBUILD_DNAME) \
	               -f $(HCP_WEBTOPRDESKTOPWEBBUILD_DFILE) \
	               $(HCP_WEBTOPRDESKTOPWEB_OUT)
	$Qtouch $@
$(eval $(call pp_rule_docker_image_rm,\
	$(HCP_WEBTOPRDESKTOPWEBBUILD_TFILE),\
	$(HCP_WEBTOPRDESKTOPWEBBUILD_DNAME),\
	webtoprdesktopweb-build,\
	clean_webtoprdesktopweb))

$(HCP_WEBTOPRDESKTOPWEB_OUT)/files.tar.gz: | $(HCP_WEBTOPRDESKTOPWEB_OUT)
$(HCP_WEBTOPRDESKTOPWEB_OUT)/files.tar.gz: $(HCP_WEBTOPRDESKTOPWEB_SRC)/files.tar.gz
$(HCP_WEBTOPRDESKTOPWEB_OUT)/files.tar.gz:
	$Qcp $< $@

$(HCP_WEBTOPRDESKTOPWEB_TFILE): $(HCP_WEBTOPRDESKTOPWEB_DFILE)
$(HCP_WEBTOPRDESKTOPWEB_TFILE): $(HCP_WEBTOPRDESKTOP_TFILE)
$(HCP_WEBTOPRDESKTOPWEB_TFILE): $(HCP_WEBTOPRDESKTOPWEBBUILD_TFILE)
$(HCP_WEBTOPRDESKTOPWEB_TFILE): $(HCP_WEBTOPRDESKTOPWEB_OUT)/files.tar.gz
$(HCP_WEBTOPRDESKTOPWEB_TFILE):
	$Qecho "Building container image $(HCP_WEBTOPRDESKTOPWEB_DNAME)"
	$Qdocker build -t $(HCP_WEBTOPRDESKTOPWEB_DNAME) \
	               -f $(HCP_WEBTOPRDESKTOPWEB_DFILE) \
	               $(HCP_WEBTOPRDESKTOPWEB_OUT)
	$Qtouch $@
$(eval $(call pp_rule_docker_image_rm,\
	$(HCP_WEBTOPRDESKTOPWEB_TFILE),\
	$(HCP_WEBTOPRDESKTOPWEB_DNAME),\
	webtoprdesktopweb,\
	clean_webtoprdesktopweb))

# Cleanup (note, we allow 'rm -rf' rather than 'rm' here, because files.tar.gz
# is extracted)
ifneq (,$(wildcard $(HCP_WEBTOPRDESKTOPWEB_OUT)))
clean_webtoprdesktopweb: | preclean
	$Qrm -f $(HCP_WEBTOPRDESKTOPWEB_DFILE) $(HCP_WEBTOPRDESKTOPWEB_TFILE)
	$Qrm -f $(HCP_WEBTOPRDESKTOPWEBBUILD_DFILE) $(HCP_WEBTOPRDESKTOPWEBBUILD_TFILE)
	$Qrm -rf $(HCP_WEBTOPRDESKTOPWEB_OUT)
clean_webtopbuilder: clean_webtoprdesktopweb
endif
