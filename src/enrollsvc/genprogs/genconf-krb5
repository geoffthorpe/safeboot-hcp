#!/bin/bash

cd "$1"

myjson=$(echo "$ENROLL_JSON" | jq -r '.["genconf-krb5"] // empty')
if [[ -z $myjson ]]; then
	printenv | egrep -e "^ENROLL" | sort >&2
	exit 0
fi

echo "# Generated by enrollsvc::genconf-krb5" > krb5.conf

for sectionname in libdefaults appdefaults; do
	sectionjson=$(echo "$myjson" | jq -r ".[\"$sectionname\"] // empty")
	if [[ -z $sectionjson ]]; then
		continue
	fi
	echo "[$sectionname]" >> krb5.conf
	sectionkeys=( $(echo "$sectionjson" | jq -r 'keys[]') )
	for key in ${sectionkeys[@]}; do
		localvalue=$(echo "$sectionjson" | jq -r ".[\"$key\"] // empty")
		echo "    $key = $localvalue" >> krb5.conf
	done
done

# Note the distinctions between singular (realm) and plural (realms)
realmsjson=$(echo "$myjson" | jq -r '.realms // {}')
realms=( $(echo "$realmsjson" | jq -r 'keys[] // empty') )
if [[ ${#realms[@]} -gt 0 ]]; then
	echo "[realms]" >> krb5.conf
fi
for realm in ${realms[@]}; do
	realmjson=$(echo "$realmsjson" | jq -r ".[\"$realm\"] // {}")
	realmkeys=( $(echo "$realmjson" | jq -r 'keys[]') )
	echo "    $realm = {" >> krb5.conf
	for key in ${realmkeys[@]}; do
		localvalue=$(echo "$realmjson" | jq -r ".[\"$key\"] // empty")
		echo "        $key = $localvalue" >> krb5.conf
	done
	echo "    }" >> krb5.conf
done

echo "public krb5.conf"
