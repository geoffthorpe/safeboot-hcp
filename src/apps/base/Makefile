HCP_APPS_BASE_SRC := $(HCP_APPS_SRC)/base
HCP_APPS_BASE_OUT := $(HCP_APPS_OUT)/base

$(HCP_APPS_BASE_OUT): | $(HCP_APPS_OUT)
MDIRS += $(HCP_APPS_BASE_OUT)

# A wrapper target to build the "apps_base" image
apps_base: $(HCP_APPS_BASE_OUT)/built
ALL += $(HCP_APPS_BASE_OUT)/built

HCP_APPS_BASE_DNAME := $(call HCP_IMAGE,apps_base)
HCP_APPS_BASE_TFILE := $(HCP_APPS_BASE_OUT)/built
HCP_APPS_BASE_DFILE := $(HCP_APPS_BASE_OUT)/Dockerfile

# We're going to assume that the apps_base image should have all the
# locally-built packages $(HCP_DBB_LIST) preinstalled.
APPS_BASE_DEPS := $(HCP_DBB_LIST)

APPS_BASE_CLEANUP_PKGS :=
APPS_BASE_TFILE_DEPS :=
$(eval $(call hcp_dbb,\
	$(APPS_BASE_DEPS),\
	$(HCP_APPS_BASE_OUT),\
	APPS_BASE_CLEANUP_PKGS,\
	APPS_BASE_TFILE_DEPS))

APPS_BASE_DBB_DFILE := $(HCP_APPS_BASE_OUT)/dbb.Dockerfile
$(APPS_BASE_DBB_DFILE): | $(HCP_APPS_BASE_OUT)
APPS_BASE_DBB_ENVS := { \"DEPS\": \"$(APPS_BASE_DEPS)\"
$(foreach d,$(APPS_BASE_DEPS),\
$(if $($d_LOCAL_FILE),\
$(eval APPS_BASE_DBB_ENVS += , \"$d_LOCAL_FILE\" : \"$($d_LOCAL_FILE)\")))
APPS_BASE_DBB_ENVS += }
$(APPS_BASE_DBB_DFILE):
	$Qecho "# auto-generated by debbase/Makefile" > $@
	$Qecho "$(APPS_BASE_DBB_ENVS)" | $(HCP_DEBBUILDER_SRC)/produce_dockerfile_stub.py > $@

$(HCP_APPS_BASE_DFILE): | $(HCP_APPS_BASE_OUT)
$(HCP_APPS_BASE_DFILE): $(HCP_APPS_BASE_SRC)/Makefile
$(HCP_APPS_BASE_DFILE): $(HCP_APPS_BASE_SRC)/Dockerfile
$(HCP_APPS_BASE_DFILE): $(APPS_BASE_DBB_DFILE)
$(HCP_APPS_BASE_DFILE):
	$Qecho "FROM $(HCP_BASE_DNAME)" > $@
	$Qcat $(APPS_BASE_DBB_DFILE) >> $@
	$Qcat $(HCP_APPS_BASE_SRC)/Dockerfile >> $@

$(HCP_APPS_BASE_TFILE): $(HCP_APPS_BASE_DFILE)
$(HCP_APPS_BASE_TFILE): $(HCP_BASE_TFILE)
$(HCP_APPS_BASE_TFILE): $(APPS_BASE_TFILE_DEPS)
$(HCP_APPS_BASE_TFILE):
	$Qecho "Building container image $(HCP_APPS_BASE_DNAME)"
	$Qdocker build -t $(HCP_APPS_BASE_DNAME) \
	               -f $(HCP_APPS_BASE_DFILE) \
	               $(HCP_APPS_BASE_OUT)
	$Qtouch $@
$(eval $(call pp_rule_docker_image_rm,\
	$(HCP_APPS_BASE_TFILE),\
	$(HCP_APPS_BASE_DNAME),\
	apps_base,\
	clean_apps_base))

# Cleanup
ifneq (,$(wildcard $(HCP_APPS_BASE_OUT)))
clean_apps_base: | preclean
	$Qrm -f $(HCP_APPS_BASE_DFILE) $(HCP_APPS_BASE_TFILE) \
		$(APPS_BASE_DBB_DFILE) $(APPS_BASE_CLEANUP_PKGS)
	$Qrmdir $(HCP_APPS_BASE_OUT)
clean_base: clean_apps_base
clean_apps: clean_apps_base
endif

